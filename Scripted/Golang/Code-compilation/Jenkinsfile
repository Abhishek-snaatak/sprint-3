node {

    env.GIT_URL = 'https://github.com/OT-MICROSERVICES/employee-api.git'
    env.GIT_BRANCH = 'main'
    env.BINARY_NAME = 'employee-api'
    env.LOG_FILE = 'compile_debug.log'

    try {

        stage('Prepare Workspace') {
            sh '''
              mkdir -p "$WORKSPACE"
              : > "$LOG_FILE"
            '''
        }

        stage('Checkout') {
            echo "Checking out ${env.GIT_URL} @ ${env.GIT_BRANCH}"
            git branch: env.GIT_BRANCH, url: env.GIT_URL
        }

        stage('Verify Go Environment') {
            sh '''
              set -xe
              echo ">>> Verifying Go installation" | tee -a $LOG_FILE
              go version | tee -a $LOG_FILE
              go env GOPATH GOROOT | tee -a $LOG_FILE
            '''
        }

        stage('Clean & Compile') {
            sh '''
              set -xe
              rm -f $BINARY_NAME

              echo ">>> Downloading dependencies" | tee -a $LOG_FILE
              go mod download | tee -a $LOG_FILE

              echo ">>> Building Go binary" | tee -a $LOG_FILE
              CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
              go build -o $BINARY_NAME . | tee -a $LOG_FILE
            '''
        }

        stage('Verify Compilation Output') {
            sh '''
              set -xe
              test -f $BINARY_NAME
              ls -lh $BINARY_NAME
            '''
        }

        stage('Archive Artifacts') {
            archiveArtifacts artifacts: env.BINARY_NAME, fingerprint: true
        }

        stage('Slack Notification (SUCCESS)') {
            sendSlack('SUCCESS', 'âœ… BUILD SUCCESS', 'SUCCESS ðŸŽ‰')
        }

    } catch (err) {

        stage('Slack Notification (FAILED)') {
            sendSlack('FAILED', 'âŒ BUILD FAILED', 'FAILED ðŸš¨')
        }

        throw err
    }
}

/* ---------------- SLACK FUNCTION ---------------- */

def sendSlack(String status, String headerText, String statusText) {

    withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {

        sh """
          set -e

          TIMESTAMP=\$(date "+%Y-%m-%d %H:%M:%S")

          cat > payload.json <<EOF
{
  "blocks": [
    {
      "type": "header",
      "text": { "type": "plain_text", "text": "${headerText}" }
    },
    {
      "type": "section",
      "fields": [
        { "type": "mrkdwn", "text": "*Job:*\\n${env.JOB_NAME}" },
        { "type": "mrkdwn", "text": "*Build #:*\\n#${env.BUILD_NUMBER}" },
        { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
        { "type": "mrkdwn", "text": "*Status:*\\n${statusText}" }
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Build URL:*\\n<${env.BUILD_URL}|Open in Jenkins>"
      }
    },
    {
      "type": "context",
      "elements": [
        { "type": "mrkdwn", "text": "ðŸ•’ *Time (IST):* ${TIMESTAMP}" }
      ]
    }
  ]
}
EOF

          echo "Sending Slack payload:"
          cat payload.json

          RESPONSE=\$(curl -s -w "\\nHTTP_CODE:%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            --data-binary @payload.json \
            "\$SLACK_WEBHOOK_URL")

          echo "Slack response:"
          echo "\$RESPONSE"

          echo "\$RESPONSE" | grep -q "HTTP_CODE:200"
        """
    }
}
