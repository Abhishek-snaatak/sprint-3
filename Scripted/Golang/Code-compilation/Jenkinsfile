node {

  // =========================
  // CONFIG
  // =========================
  def GIT_URL    = 'https://github.com/OT-MICROSERVICES/employee-api.git'
  def GIT_BRANCH = 'main'
  def DEBUG_LOG  = "${env.WORKSPACE}/compile_debug.log"
  def BINARY     = 'employee-api'
  def BUILD_PATH = '.'

  // =========================
  // INIT
  // =========================
  sh "mkdir -p ${env.WORKSPACE}"
  sh "touch ${DEBUG_LOG}"

  try {

    // =========================
    // CHECKOUT
    // =========================
    stage('Checkout') {
      echo "Checking out ${GIT_URL} @ ${GIT_BRANCH}"
      git url: GIT_URL, branch: GIT_BRANCH
    }

    // =========================
    // DETECT BUILD PATH
    // =========================
    stage('Detect Go Build Path') {
      sh '''
        if [ -d cmd ]; then
          echo "cmd" > .build_path
        else
          echo "." > .build_path
        fi
      '''
      BUILD_PATH = readFile('.build_path').trim()
      echo "Go build path detected: ${BUILD_PATH}"
    }

    // =========================
    // VERIFY GO
    // =========================
    stage('Verify Go Environment') {
      sh '''
        set -xe
        echo ">>> Verifying Go installation" | tee -a compile_debug.log
        go version | tee -a compile_debug.log
        go env GOPATH GOROOT | tee -a compile_debug.log
      '''
    }

    // =========================
    // CLEAN & COMPILE
    // =========================
    stage('Clean & Compile') {
      sh """
        set -xe
        rm -f ${BINARY}

        echo ">>> Downloading dependencies" | tee -a ${DEBUG_LOG}
        go mod download | tee -a ${DEBUG_LOG}

        echo ">>> Building Go binary" | tee -a ${DEBUG_LOG}
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -o ${BINARY} ${BUILD_PATH} | tee -a ${DEBUG_LOG}
      """
    }

    // =========================
    // VERIFY OUTPUT
    // =========================
    stage('Verify Compilation Output') {
      sh """
        set -xe
        if [ ! -f ${BINARY} ]; then
          echo "ERROR: Go binary not found!" | tee -a ${DEBUG_LOG}
          exit 20
        fi
        ls -lh ${BINARY}
      """
    }

    // =========================
    // ARCHIVE
    // =========================
    stage('Archive Artifacts') {
      archiveArtifacts artifacts: "${BINARY}", fingerprint: true
      archiveArtifacts artifacts: "compile_debug.log", fingerprint: true
    }

    // =========================
    // SLACK SUCCESS
    // =========================
    stage('Slack Success Notification') {
      withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
        sh """
          payload='{
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "‚úÖ BUILD SUCCESS" }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Job:*\\n${env.JOB_NAME}" },
                  { "type": "mrkdwn", "text": "*Build #:*\\n#${env.BUILD_NUMBER}" },
                  { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
                  { "type": "mrkdwn", "text": "*Status:*\\nSUCCESS üéâ" }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Build URL:*\\n<${env.BUILD_URL}|Open in Jenkins>"
                }
              },
              {
                "type": "context",
                "elements": [
                  { "type": "mrkdwn", "text": "üïí *Time (IST):* \$(date '+%Y-%m-%d %H:%M:%S')" }
                ]
              }
            ]
          }'

          curl -s -X POST -H "Content-type: application/json" \
            --data "\$payload" "\$SLACK_WEBHOOK_URL"
        """
      }
    }

  } catch (err) {

    // =========================
    // SLACK FAILURE
    // =========================
    withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
      sh """
        payload='{
          "blocks": [
            {
              "type": "header",
              "text": { "type": "plain_text", "text": "‚ùå BUILD FAILED" }
            },
            {
              "type": "section",
              "fields": [
                { "type": "mrkdwn", "text": "*Job:*\\n${env.JOB_NAME}" },
                { "type": "mrkdwn", "text": "*Build #:*\\n#${env.BUILD_NUMBER}" },
                { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
                { "type": "mrkdwn", "text": "*Status:*\\nFAILED üö®" }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Build URL:*\\n<${env.BUILD_URL}|Open in Jenkins>"
              }
            },
            {
              "type": "context",
              "elements": [
                { "type": "mrkdwn", "text": "üïí *Time (IST):* \$(date '+%Y-%m-%d %H:%M:%S')" }
              ]
            }
          ]
        }'

        curl -s -X POST -H "Content-type: application/json" \
          --data "\$payload" "\$SLACK_WEBHOOK_URL"
      """
    }

    throw err
  }

}
