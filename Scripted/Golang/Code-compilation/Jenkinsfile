node {

  def GIT_URL    = 'https://github.com/OT-MICROSERVICES/employee-api.git'
  def GIT_BRANCH = 'main'
  def BINARY     = 'employee-api'
  def DEBUG_LOG  = 'compile_debug.log'

  sh "mkdir -p ${env.WORKSPACE}"
  sh "touch ${DEBUG_LOG}"

  try {

    stage('Checkout') {
      echo "Checking out ${GIT_URL} @ ${GIT_BRANCH}"
      git url: GIT_URL, branch: GIT_BRANCH
    }

    stage('Verify Go Environment') {
      sh '''
        set -xe
        echo ">>> Verifying Go installation" | tee -a compile_debug.log
        go version | tee -a compile_debug.log
        go env GOPATH GOROOT | tee -a compile_debug.log
      '''
    }

    stage('Clean & Compile') {
      sh '''
        set -xe
        rm -f employee-api

        echo ">>> Downloading dependencies" | tee -a compile_debug.log
        go mod download | tee -a compile_debug.log

        echo ">>> Building Go binary" | tee -a compile_debug.log
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o employee-api .
      '''
    }

    stage('Verify Compilation Output') {
      sh '''
        set -xe
        if [ ! -f employee-api ]; then
          echo "ERROR: Go binary not found!" | tee -a compile_debug.log
          exit 20
        fi
        ls -lh employee-api
      '''
    }

    stage('Archive Artifacts') {
      archiveArtifacts artifacts: 'employee-api', fingerprint: true
      archiveArtifacts artifacts: 'compile_debug.log', fingerprint: true
    }

    stage('Slack Notification (success)') {
      withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
        sh '''
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

          payload=$(cat <<EOF
{
  "blocks": [
    {
      "type": "header",
      "text": { "type": "plain_text", "text": "âœ… BUILD SUCCESS" }
    },
    {
      "type": "section",
      "fields": [
        { "type": "mrkdwn", "text": "*Job:*\\n'"$JOB_NAME"'" },
        { "type": "mrkdwn", "text": "*Build #:*\\n#'"$BUILD_NUMBER"'" },
        { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
        { "type": "mrkdwn", "text": "*Status:*\\nSUCCESS ðŸŽ‰" }
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Build URL:*\\n<'"$BUILD_URL"'|Open in Jenkins>"
      }
    },
    {
      "type": "context",
      "elements": [
        { "type": "mrkdwn", "text": "ðŸ•’ *Time (IST):* '"$TIMESTAMP"'" }
      ]
    }
  ]
}
EOF
)

          curl -s -X POST -H "Content-Type: application/json" \
            --data "$payload" "$SLACK_WEBHOOK_URL"
        '''
      }
    }

  } catch (err) {

    stage('Slack Notification (failure)') {
      withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
        sh '''
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

          payload=$(cat <<EOF
{
  "blocks": [
    {
      "type": "header",
      "text": { "type": "plain_text", "text": "âŒ BUILD FAILED" }
    },
    {
      "type": "section",
      "fields": [
        { "type": "mrkdwn", "text": "*Job:*\\n'"$JOB_NAME"'" },
        { "type": "mrkdwn", "text": "*Build #:*\\n#'"$BUILD_NUMBER"'" },
        { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
        { "type": "mrkdwn", "text": "*Status:*\\nFAILED ðŸš¨" }
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Build URL:*\\n<'"$BUILD_URL"'|Open in Jenkins>"
      }
    },
    {
      "type": "context",
      "elements": [
        { "type": "mrkdwn", "text": "ðŸ•’ *Time (IST):* '"$TIMESTAMP"'" }
      ]
    }
  ]
}
EOF
)

          curl -s -X POST -H "Content-Type: application/json" \
            --data "$payload" "$SLACK_WEBHOOK_URL"
        '''
      }
    }

    throw err
  }
}
