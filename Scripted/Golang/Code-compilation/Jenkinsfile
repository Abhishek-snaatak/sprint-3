node {

  def GIT_URL    = 'https://github.com/OT-MICROSERVICES/employee-api.git'
  def GIT_BRANCH = 'main'
  def BINARY     = 'employee-api'
  def DEBUG_LOG  = 'compile_debug.log'

  sh "mkdir -p ${env.WORKSPACE}"
  sh "touch ${DEBUG_LOG}"

  try {

    stage('Checkout') {
      echo "Checking out ${GIT_URL} @ ${GIT_BRANCH}"
      git url: GIT_URL, branch: GIT_BRANCH
    }

    stage('Verify Go Environment') {
      sh '''
        set -xe
        echo ">>> Verifying Go installation" | tee -a compile_debug.log
        go version | tee -a compile_debug.log
        go env GOPATH GOROOT | tee -a compile_debug.log
      '''
    }

    stage('Clean & Compile') {
      sh '''
        set -xe
        rm -f employee-api

        echo ">>> Downloading dependencies" | tee -a compile_debug.log
        go mod download | tee -a compile_debug.log

        echo ">>> Building Go binary" | tee -a compile_debug.log
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o employee-api .
      '''
    }

    stage('Verify Compilation Output') {
      sh '''
        set -xe
        if [ ! -f employee-api ]; then
          echo "ERROR: Go binary not found!" | tee -a compile_debug.log
          exit 20
        fi
        ls -lh employee-api
      '''
    }

    stage('Archive Artifacts') {
      archiveArtifacts artifacts: 'employee-api', fingerprint: true
      archiveArtifacts artifacts: 'compile_debug.log', fingerprint: true
    }

stage('Slack Notification (success)') {
  withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
    sh '''
      set -e

      if [ -z "$SLACK_WEBHOOK_URL" ]; then
        echo "ERROR: SLACK_WEBHOOK_URL is empty"
        exit 1
      fi

      TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

      cat > payload.json <<EOF
{
  "text": "âœ… *BUILD SUCCESS*",
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Job:* $JOB_NAME\\n*Build #:* #$BUILD_NUMBER\\n*Status:* SUCCESS ðŸŽ‰\\n*Time:* $TIMESTAMP"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Build URL:* <$BUILD_URL|Open in Jenkins>"
      }
    }
  ]
}
EOF

      echo "Sending payload:"
      cat payload.json

      RESPONSE=$(curl -s -w "\\nHTTP_CODE:%{http_code}" \
        -X POST \
        -H "Content-Type: application/json" \
        --data-binary @payload.json \
        "$SLACK_WEBHOOK_URL")

      echo "Slack response:"
      echo "$RESPONSE"

      echo "$RESPONSE" | grep -q "HTTP_CODE:200"
    '''
  }
}
