pipeline {

  agent any

  environment {
    GIT_URL    = 'https://github.com/OT-MICROSERVICES/salary-api.git'
    GIT_BRANCH = 'main'
    DEBUG_LOG  = "${WORKSPACE}/compile_debug.log"
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  stages {

    stage('Checkout') {
      steps {
        echo "Checking out ${GIT_URL} @ ${GIT_BRANCH}"
        git url: "${GIT_URL}", branch: "${GIT_BRANCH}"
      }
    }

    stage('Verify Java & Maven') {
      steps {
        sh '''
          set -xe
          echo ">>> Verify Java & Maven" | tee -a "${DEBUG_LOG}"
          java -version 2>&1 | tee -a "${DEBUG_LOG}"
          mvn -version  2>&1 | tee -a "${DEBUG_LOG}"
        '''
      }
    }

    stage('Clean & Compile (No Tests)') {
      steps {
        sh '''
          set -xe
          echo ">>> Maven clean compile (skip tests)" | tee -a "${DEBUG_LOG}"
          mvn clean compile -DskipTests 2>&1 | tee -a "${DEBUG_LOG}"
        '''
      }
    }

    stage('Verify Compilation Output') {
      steps {
        sh '''
          set -xe
          echo ">>> Verifying target/classes" | tee -a "${DEBUG_LOG}"
          if [ ! -d "target/classes" ]; then
            echo "ERROR: target/classes not found!" | tee -a "${DEBUG_LOG}"
            exit 20
          fi
          ls -la target/classes | tee -a "${DEBUG_LOG}"
        '''
      }
    }

    stage('Archive Artifacts') {
      steps {
        echo "Archiving compiled classes"
        archiveArtifacts artifacts: 'target/classes/**', fingerprint: true
        archiveArtifacts artifacts: 'compile_debug.log', fingerprint: true
      }
    }
  }

    post {

        success {
            echo "Build success — sending Slack notification"

            withCredentials([string(credentialsId: 'slack-webhook',
                                    variable: 'SLACK_WEBHOOK_URL')]) {

                sh '''
                    ARTIFACT="${BUILD_URL}artifact/zap_reports/${REPORT_NAME}"
                    TIMESTAMP="$(date +'%Y-%m-%d %H:%M:%S')"

                    MSG=":white_check_mark: *SUCCESS*  
ZAP scan completed.  
*Target:* ${TARGET_URL}  
*Report:* ${ARTIFACT}  
*Time:* ${TIMESTAMP}"


                    curl -s -X POST \
                      -H 'Content-type: application/json' \
                      --data "{\"text\":\"${MSG}\"}" \
                      "$SLACK_WEBHOOK_URL" || true
                '''
            }
        }

        failure {
            echo "Build failed — sending Slack notification"

            withCredentials([string(credentialsId: 'slack-webhook',
                                    variable: 'SLACK_WEBHOOK_URL')]) {

                sh '''
                    TIMESTAMP="$(date +'%Y-%m-%d %H:%M:%S')"

                    MSG=":x: *FAILED*  
Build or ZAP scan failed.  
*Job:* ${JOB_NAME}  
*Build:* #${BUILD_NUMBER}  
*URL:* ${BUILD_URL}  
*Time:* ${TIMESTAMP}"


                    curl -s -X POST \
                      -H 'Content-type: application/json' \
                      --data "{\"text\":\"${MSG}\"}" \
                      "$SLACK_WEBHOOK_URL" || true
                '''
            }
        }
    }
}
