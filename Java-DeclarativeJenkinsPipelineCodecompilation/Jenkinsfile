pipeline {

  agent any

  environment {
    GIT_URL    = 'https://github.com/OT-MICROSERVICES/salary-api.git'
    GIT_BRANCH = 'main'
    DEBUG_LOG  = "${WORKSPACE}/compile_debug.log"
  }

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  stages {

    stage('Checkout') {
      steps {
        echo "Checking out ${GIT_URL} @ ${GIT_BRANCH}"
        git url: "${GIT_URL}", branch: "${GIT_BRANCH}"
      }
    }

    stage('Verify Java & Maven') {
      steps {
        sh '''
          set -xe
          echo ">>> Verify Java & Maven" | tee -a "${DEBUG_LOG}"
          java -version 2>&1 | tee -a "${DEBUG_LOG}"
          mvn -version  2>&1 | tee -a "${DEBUG_LOG}"
        '''
      }
    }

    stage('Clean & Compile (No Tests)') {
      steps {
        sh '''
          set -xe
          echo ">>> Maven clean compile (skip tests)" | tee -a "${DEBUG_LOG}"
          mvn clean compile -DskipTests 2>&1 | tee -a "${DEBUG_LOG}"
        '''
      }
    }

    stage('Verify Compilation Output') {
      steps {
        sh '''
          set -xe
          echo ">>> Verifying target/classes" | tee -a "${DEBUG_LOG}"
          if [ ! -d "target/classes" ]; then
            echo "ERROR: target/classes not found!" | tee -a "${DEBUG_LOG}"
            exit 20
          fi
          ls -la target/classes | tee -a "${DEBUG_LOG}"
        '''
      }
    }

    stage('Archive Artifacts') {
      steps {
        echo "Archiving compiled classes"
        archiveArtifacts artifacts: 'target/classes/**', fingerprint: true
        archiveArtifacts artifacts: 'compile_debug.log', fingerprint: true
      }
    }

    stage('Slack Success Notification') {
      when {
        expression {
          currentBuild.result == null || currentBuild.result == 'SUCCESS'
        }
      }
      steps {
        withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
          sh '''
            payload=$(cat <<EOF
{
  "blocks": [
    {
      "type": "header",
      "text": { "type": "plain_text", "text": "âœ… BUILD SUCCESS" }
    },
    {
      "type": "section",
      "fields": [
        { "type": "mrkdwn", "text": "*Job:*\\n${JOB_NAME}" },
        { "type": "mrkdwn", "text": "*Build #:*\\n#${BUILD_NUMBER}" },
        { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
        { "type": "mrkdwn", "text": "*Status:*\\nSUCCESS ðŸŽ‰" }
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Build URL:*\\n<${BUILD_URL}|Open in Jenkins>"
      }
    },
    {
      "type": "context",
      "elements": [
        { "type": "mrkdwn", "text": "ðŸ•’ *Time (IST):* $(date '+%Y-%m-%d %H:%M:%S')" }
      ]
    }
  ]
}
EOF
)
            curl -s -X POST -H "Content-type: application/json" \
              --data "$payload" "$SLACK_WEBHOOK_URL" || true
          '''
        }
      }
    }

  } // stages

  post {

    failure {
      echo "Build failed â€” notifying Slack"
      withCredentials([string(credentialsId: 'slack-webhook', variable: 'SLACK_WEBHOOK_URL')]) {
        sh '''
          payload=$(cat <<EOF
{
  "blocks": [
    {
      "type": "header",
      "text": { "type": "plain_text", "text": "âŒ BUILD FAILED" }
    },
    {
      "type": "section",
      "fields": [
        { "type": "mrkdwn", "text": "*Job:*\\n${JOB_NAME}" },
        { "type": "mrkdwn", "text": "*Build #:*\\n#${BUILD_NUMBER}" },
        { "type": "mrkdwn", "text": "*Triggered By:*\\nJenkins" },
        { "type": "mrkdwn", "text": "*Status:*\\nFAILED ðŸš¨" }
      ]
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Build URL:*\\n<${BUILD_URL}|Open in Jenkins>"
      }
    },
    {
      "type": "context",
      "elements": [
        { "type": "mrkdwn", "text": "ðŸ•’ *Time (IST):* $(date '+%Y-%m-%d %H:%M:%S')" }
      ]
    }
  ]
}
EOF
)
          curl -s -X POST -H "Content-type: application/json" \
            --data "$payload" "$SLACK_WEBHOOK_URL" || true
        '''
      }
    }

    always {
      echo "Job finished: ${JOB_NAME} #${BUILD_NUMBER}"
    }

  }

}
